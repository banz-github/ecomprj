{% extends 'admindash/base-dash.html' %}
{% load static %}
{% block content %}       
    {% load humanize %}
    {% load custom_filters %}

        <main>
            <div class="date">
                <form method="GET">
                    <label for="datePicker">Select Date:</label>
                    <input type="date" id="dateFilter" name="selected_date">
                    <input type="submit" value="Apply">
                </form>
            </div>
            <!-- END OF INSIGHTS -->
            <div class="recent-orders">
                <h2>All Custom Orders</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Custom Order ID</th>
                                <th>Product Type</th>
                                <th>Material</th>
                                <th>Color</th>
                                <th>Foam Type</th>
                                <th>M/R</th>
                                <th>Quantity</th>
                                <th>Payment Approved</th>
                                <th>Percentage</th>
                                <th>Receipt Submitted</th>
                                {% comment %} <th>With Downpayment</th> {% endcomment %}
                                <th>Paid Amount</th>
                                <th>Date Approved</th>
                                <th>Verifier</th>


                            </tr>
                            
                        </thead>
                        <tbody>
                            {% for col in custom_order_list %}
                            <tr>
                                <td data-date="{{ col.date_approved }}">{{col.profile}}</td>
                                <td data-date="{{ col.date_approved }}">{{col.co_id}}</td>
                                <td data-date="{{ col.date_approved }}"><a href="{% url 'core:most_ordered_materials' product_type=col.product_type %}" class="primary">{{col.product_type}}</a></td>
                                <td data-date="{{ col.date_approved }}">{{col.material|title}}</td>
                                <td data-date="{{ col.date_approved }}">{{col.color|title}}</td>
                                <td data-date="{{ col.date_approved }}">{{col.foam_type|title}}</td>
                                <td data-date="{{ col.date_approved }}">{{col.make_or_repair|title}}</td>
                                <td data-date="{{ col.date_approved }}">{{col.qty|title}}</td>
                                {% if col.with_downpayment == True %}
                                <td><i class="fas fa-check-circle text-success">✔️</i></td>
                                {% else %}
                                <td class="text-danger"><strong>X</strong></td>
                                {% endif %}
                                <td data-date="{{ col.date_approved }}">{{col.percentage_progress}}%</td>

                                {% if col.receipt_submitted == True %}
                                <td><i class="fas fa-check-circle text-success">✔️</i></td>
                                {% else %}
                                <td class="text-danger"><strong>X</strong></td>
                                {% endif %}
                                <td data-date="{{ col.date_approved }}">₱{{col.paid_amount}}</td>
                                <th data-date="{{ col.date_approved }}">{{col.date_approved}}</th>

                                <th data-date="{{ col.date_approved }}">{{col.admin_profile}}</th>

                                <td><a href="{% url 'core:custom_order_detail_dashboard' co_id=col.co_id %}" class="primary">View</a></td>
                                {% comment %} <td><a href="{% url 'core:order-detail' o.id %}" class="btn-small d-block">View</a></td>

                                <td class="warning">Pending</td>
                                <td class="primary">Details</td> {% endcomment %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                

            </div>
            <br>
            <div class="recent-orders">
                <h2>All Approved Custom Orders</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Custom Order ID</th>
                                <th>Product Type</th>
                                <th>Material</th>
                                <th>Color</th>
                                <th>Foam Type</th>
                                <th>M/R</th>
                                <th>Quantity</th>
                                <th>Payment Approved</th>
                                <th>Percentage</th>
                                <th>Receipt Submitted</th>
                                {% comment %} <th>With Downpayment</th> {% endcomment %}
                                <th>Paid Amount</th>
                                <th>Date Approved</th>
                                <th>Verifier</th>


                            </tr>
                            
                        </thead>
                        <tbody>
                            {% for cola in custom_order_list_approved %}
                            <tr>
                                <td data-date="{{ cola.date_approved }}">{{cola.profile}}</td>
                                <td data-date="{{ cola.date_approved }}">{{cola.co_id}}</td>
                                <td data-date="{{ cola.date_approved }}"><a href="{% url 'core:most_ordered_materials' product_type=cola.product_type %}" class="primary">{{cola.product_type}}</a></td>
                                <td data-date="{{ cola.date_approved }}">{{cola.material|title}}</td>
                                <td data-date="{{ cola.date_approved }}">{{cola.color|title}}</td>
                                <td data-date="{{ cola.date_approved }}">{{cola.foam_type|title}}</td>
                                <td data-date="{{ cola.date_approved }}">{{cola.make_or_repair|title}}</td>
                                <td data-date="{{ cola.date_approved }}">{{cola.qty|title}}</td>
                                {% if cola.with_downpayment == True %}
                                <td><i class="fas fa-check-circle text-success">✔️</i></td>
                                {% else %}
                                <td class="text-danger"><strong>X</strong></td>
                                {% endif %}
                                <td data-date="{{ cola.date_approved }}">{{cola.percentage_progress}}%</td>

                                {% if cola.receipt_submitted == True %}
                                <td><i class="fas fa-check-circle text-success">✔️</i></td>
                                {% else %}
                                <td class="text-danger"><strong>X</strong></td>
                                {% endif %}
                                <td data-date="{{ cola.date_approved }}">₱{{cola.paid_amount}}</td>
                                <th data-date="{{ cola.date_approved }}">{{cola.date_approved}}</th>

                                <th data-date="{{ cola.date_approved }}">{{cola.admin_profile}}</th>

                                <td><a href="{% url 'core:custom_order_detail_dashboard' co_id=cola.co_id %}" class="primary">View</a></td>
                                {% comment %} <td><a href="{% url 'core:order-detail' o.id %}" class="btn-small d-block">View</a></td>

                                <td class="warning">Pending</td>
                                <td class="primary">Details</td> {% endcomment %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                

            </div>
        <!-- ... (existing code) -->    
        <!-- ... (existing code) -->
<!-- ... (existing code) -->
<!-- Bar Graph Container for Most Ordered Product Types -->
<div class="bar-graph-container">
    <canvas style="height:300px;" id="productTypeBarGraph"></canvas>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('dateFilter').addEventListener('change', function() {
            const selectedDate = this.value;
            const formattedSelectedDate = convertDateFormat(selectedDate);

            console.log('Selected Date:', formattedSelectedDate);

            filterByDate('.recent-orders tbody tr', formattedSelectedDate);
            filterByDate('.analytics-section tbody tr', formattedSelectedDate);

            const allTimeSections = document.querySelectorAll('.analytics-section');
            allTimeSections.forEach(function(section) {
                const hasSelectedDate = selectedDate !== '';
                if (hasSelectedDate) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });

            const newProductTypeData = {
                labels: [{% for product_type in most_ordered_product_types %}"{{ product_type.product_type__name }}",{% endfor %}],
                datasets: [{
                    label: 'Total Quantity for Each Product Type',
                    backgroundColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                    borderColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                    borderWidth: 1,
                    data: [{% for product_type in most_ordered_product_types %}{{ product_type.total_quantity }},{% endfor %}]
                }]
            };

            console.log('New Product Type Data:', newProductTypeData);

            productTypeBarGraph.data = newProductTypeData;
            productTypeBarGraph.update();
        });

        const productTypeData = {
            labels: [{% for product_type in most_ordered_product_types %}"{{ product_type.product_type__name }}",{% endfor %}],
            datasets: [{
                label: 'Total Quantity for Each Product Type',
                backgroundColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                borderColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                borderWidth: 1,
                data: [{% for product_type in most_ordered_product_types %}{{ product_type.total_quantity }},{% endfor %}]
            }]
        };

        const productTypeConfig = {
            type: 'bar',
            data: productTypeData,
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Product Type'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Total Quantity'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                    }
                }
            }
        };

        const productTypeBarGraph = new Chart(
            document.getElementById('productTypeBarGraph'),
            productTypeConfig
        );
    });

    function convertDateFormat(dateString) {
        const date = new Date(dateString);
        
        if (isNaN(date.getTime())) {
            return ''; // Invalid date format
        }

        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' };
        return date.toLocaleDateString('en-US', options);
    }

    function filterByDate(selector, selectedDate) {
        const elements = document.querySelectorAll(selector);
        elements.forEach(function (element) {
            const elementDate = element.querySelector('td[data-date]').getAttribute('data-date');
            const isoSelectedDate = new Date(selectedDate).toISOString().slice(0, 16).replace("T", ", ");
            const isoElementDate = new Date(elementDate).toISOString().slice(0, 16).replace("T", ", ");

            if (selectedDate === '' || isoSelectedDate === isoElementDate) {
                element.style.display = '';
            } else {
                element.style.display = 'none';
            }
        });
    }
</script>







        </main>

        {% endblock content %}
    {% comment %} <script>
        const productTypeData = {
            labels: [{% for product_type in most_ordered_product_types %}"{{ product_type.product_type__name }}",{% endfor %}],
            datasets: [{
                label: 'Total Quantity for Each Product Type',
                backgroundColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                borderColor: [{% for product_type in most_ordered_product_types %}'{{ product_type|random_color }}',{% endfor %}],
                borderWidth: 1,
                data: [{% for product_type in most_ordered_product_types %}{{ product_type.total_quantity }},{% endfor %}]
            }]
        };

        const productTypeConfig = {
            type: 'bar',
            data: productTypeData,
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Product Type'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Total Quantity'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false, // Set to false to hide the legend
                    }
                }
            }
        };

        const productTypeBarGraph = new Chart(
            document.getElementById('productTypeBarGraph'),
            productTypeConfig
        );


        

    </script> {% endcomment %}